# 第 22.12 节 安装 code-server 和 clangd

> **警告**
>
> 本教程仍然需要进一步测试，请慎重参考。

## 常见问题

1. 为什么要有这篇教程？

- 有了 code-server 就意味着不用安装桌面环境即可获得运行在原生 FreeBSD 环境上的集成开发环境
- 利用熟悉的 vscode 界面和强大的 clangd 支援 FreeBSD 内核的开发

2. 为什么要用 Arch Linux 兼容层？

- 因为现在 FreeBSD 版的 code-server 被上游搞坏了几乎没法用
- 纵观历史版本也只有一个 revision 是好的
- 所以用 Linux 兼容层来运行是目前最节省时间节省生命的方案
- 并且 code-server 自从基于 node18 以后就对 glibc 的最低版本做出了更高的要求
- 源里那个 CentOS 运行时就运行不起它来了

3. 还有什么需要补充的内容？

- 如何在服务器上通过 HTTPS 来提供 code-server 服务
- 解答你在 Linux 兼容层里面却还是可以访问 FreeBSD 环境的原因
- 探讨 Linux 兼容层与 Linux Jail 究竟有何区别
- 介绍 Linux 兼容层的有关机制

4. 有什么需要注意的？

- 所有操作都使用 root 用户进行
- 请勿跳步

## 服务器启用 Linux 二进制兼容，并部署 archlinux-bootstrap 镜像

```shell
service linux enable
service linux start
fetch -o /root "https://mirrors.cernet.edu.cn/archlinux/iso/latest/archlinux-bootstrap-x86_64.tar.gz"
tar -xpf archlinux-bootstrap-x86_64.tar.gz || true
cp -Rf /root/root.x86_64/* /compat/linux
```

## 服务器配置 pacman 源，并添加 archlinuxcn 仓库

```shell
cat >/compat/linux/etc/pacman.conf <<EOF
[options]
Architecture = auto
ParallelDownloads = 5

[core]
Server = https://mirrors.cernet.edu.cn/archlinux/\$repo/os/\$arch
SigLevel = Required DatabaseOptional

[extra]
Server = https://mirrors.cernet.edu.cn/archlinux/\$repo/os/\$arch
SigLevel = Required DatabaseOptional

[archlinuxcn]
Server = https://mirrors.cernet.edu.cn/archlinuxcn/\$arch
SigLevel = Required DatabaseOptional
EOF
```

## 服务器更新 Arch Linux 运行时环境，并安装 code-server

```shell
cp /etc/resolv.conf /compat/linux/etc
chroot /compat/linux pacman-key --init
chroot /compat/linux pacman-key --populate
chroot /compat/linux pacman -Syu --noconfirm
chroot /compat/linux pacman -S --noconfirm archlinuxcn-keyring
chroot /compat/linux pacman -S --noconfirm code-server
```

## 服务器删除 Arch Linux 运行时环境中的无用目录

```shell
rm -Rf /compat/linux/home
rm -Rf /compat/linux/root
rm -Rf /compat/linux/usr/local
rm -Rf /compat/linux/usr/src
```

## 服务器安装相关开发工具并切换 shell 至 bash

```shell
pkg-static upgrade -y git bash vim tmux htop llvm bear
chsh -s /usr/local/bin/bash
```

## 服务器安装 clangd 插件并添加以下 code-server 设置

```shell
code-server --install-extension llvm-vs-code-extensions.vscode-clangd
cat >/root/.local/share/code-server/Machine/settings.json <<EOF
{
  "clangd.path": "/usr/local/bin/clangd",
  "terminal.integrated.profiles.linux": {
    "bash": { "path": "/usr/local/bin/bash" }
  }
}
EOF
```

## 服务器通过 daemon 命令启动 code-server

```shell
daemon -p /root/.code-server.pid -f /compat/linux/lib/code-server/bin/code-server --auth=none
```

## 客户端通过 SSH 建立隧道并通过浏览器连接到 code-server 服务器

```shell
ssh -L 8080:127.0.0.1:8080 -N root@server
```

在浏览器中访问 [http://127.0.0.1:8080](http://127.0.0.1:8080)

## （示例）浏览器中用 code-server 打开 FreeBSD 的源码树

```shell
code-server /usr/src
```

## （示例）浏览器中编译最小化内核并生成 `compile_commands.json` 文件

```shell
bear --append -- make KERNCONF=MINIMAL buildkernel
```

等待编译完成并生成 `compile_commands.json` 文件，然后你就可以开始阅读内核关键部分的源码了。

## 注意事项

1. 虽然为了运行 code-server 我们用到了 Linux 兼容层，但是 bash, clangd 还有任何其他工具将全部由 FreeBSD 提供
2. 这是由于我们诱导了 clangd 插件去启动 FreeBSD 上的 clangd, 与此同时我们还诱导了 Integrated Terminal 去启动 FreeBSD 上的 bash
3. 安装 bash 的另一个原因在于 Integrated Terminal 的 Shell Integration 功能只支持 bash, zsh 和 pwsh
4. 删除 `/compat/linux/usr/src` 目录的原因在于我们需要诱导 code-server 去打开 FreeBSD 上的 `/usr/src`

## 自动化安装脚本

为了便于读者快速获得开发环境，我们将安装 code-server 的步骤整理成一个脚本：

```shell
#!/bin/sh

set -e

ARCHLINUX_MIRROR="https://mirrors.cernet.edu.cn/archlinux"
ARCHLINUXCN_MIRROR="https://mirrors.cernet.edu.cn/archlinuxcn"
FREEBSD_PKG_MIRROR="https://mirrors.cernet.edu.cn/FreeBSD-pkg"

umount -Af

rm -Rf /compat/linux
rm -Rf /root/archlinux-bootstrap-x86_64.tar.gz
rm -Rf /root/root.x86_64

service linux enable
service linux start
fetch -o /root "${ARCHLINUX_MIRROR}/iso/latest/archlinux-bootstrap-x86_64.tar.gz"
tar -xpf archlinux-bootstrap-x86_64.tar.gz || true
cp -Rf /root/root.x86_64/* /compat/linux

rm -Rf /root/archlinux-bootstrap-x86_64.tar.gz
rm -Rf /root/root.x86_64

mkdir -p /usr/local/etc/pkg/repos
cat >/usr/local/etc/pkg/repos/FreeBSD.conf <<EOF
FreeBSD: { url: "${FREEBSD_PKG_MIRROR}/\${ABI}/latest" }
EOF

cat >/compat/linux/etc/pacman.conf <<EOF
[options]
Architecture = auto
ParallelDownloads = 5

[core]
Server = ${ARCHLINUX_MIRROR}/\$repo/os/\$arch
SigLevel = Required DatabaseOptional

[extra]
Server = ${ARCHLINUX_MIRROR}/\$repo/os/\$arch
SigLevel = Required DatabaseOptional

[archlinuxcn]
Server = ${ARCHLINUXCN_MIRROR}/\$arch
SigLevel = Required DatabaseOptional
EOF

cp /etc/resolv.conf /compat/linux/etc
chroot /compat/linux pacman-key --init
chroot /compat/linux pacman-key --populate
chroot /compat/linux pacman -Syu --noconfirm
chroot /compat/linux pacman -S --noconfirm archlinuxcn-keyring
chroot /compat/linux pacman -S --noconfirm code-server

rm -Rf /compat/linux/home
rm -Rf /compat/linux/root
rm -Rf /compat/linux/usr/local
rm -Rf /compat/linux/usr/src

pkg-static upgrade -y git bash vim tmux htop llvm bear
chsh -s /usr/local/bin/bash

code-server --install-extension llvm-vs-code-extensions.vscode-clangd
cat >/root/.local/share/code-server/Machine/settings.json <<EOF
{
  "clangd.path": "/usr/local/bin/clangd",
  "terminal.integrated.profiles.linux": {
    "bash": { "path": "/usr/local/bin/bash" }
  }
}
EOF
```

欢迎测试与反馈。
