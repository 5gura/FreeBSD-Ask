# 第 22.12 节 安装 code-server 和 clangd

> **警告**
>
> 本教程仍然需要进一步测试，请慎重参考。

## 常见问题

### 为什么要有这篇教程？

- 有了 code-server 就意味着不用安装桌面环境即可获得运行在原生 FreeBSD 环境上的集成开发环境
- 利用熟悉的 vscode 界面和强大的 clangd 支援 FreeBSD 内核的开发
- 这样可以大大降低投入 FreeBSD 代码贡献以及二次开发所需的学习成本

### 为什么要用 Arch Linux 兼容层？

- 因为现在 FreeBSD 版的 code-server 被上游搞坏了几乎没法用
- 纵观历史版本也只有一个 revision 是好的
- 所以用 Linux 兼容层来运行是目前最节省时间节省生命的方案
- 并且 code-server 自从基于 node18 以后就对 glibc 的最低版本做出了更高的要求
- 源里那个 CentOS 运行时就运行不起它来了

### 兼容层？那还能用来搞 FreeBSD 的开发吗？

- 当然可以
- 虽然为了运行 code-server 我们用到了 Linux 兼容层
- 但是 clangd 还有任何其他开发工具将全部由 FreeBSD 提供
- 这是由于我们将要诱导 clangd 插件去启动 FreeBSD 上的 clangd
- 与此同时我们还将诱导 Integrated Terminal 去启动 FreeBSD 上的 shell

### 还有什么需要补充的内容？

- 如何在服务器上通过 HTTPS 来提供 code-server 服务
- 解答你在 Linux 兼容层里面却还是可以访问 FreeBSD 环境的原因
- 探讨 Linux 兼容层与 Linux Jail 究竟有何区别
- 介绍 Linux 兼容层的有关机制

### 有什么需要注意的？

- 所有操作都使用 root 用户进行
- 请勿跳步

### 你这是在鼓励用户当 root 敢死队？

- 。。。

## 服务器启用 Linux 二进制兼容，并部署 archlinux-bootstrap 镜像

```shell
service linux enable
service linux start
fetch -o /root "https://mirrors.cernet.edu.cn/archlinux/iso/latest/archlinux-bootstrap-x86_64.tar.gz"
tar -xpf archlinux-bootstrap-x86_64.tar.gz || true
cp -Rf /root/root.x86_64/* /compat/linux
```

## 服务器配置 pacman 源，并添加 archlinuxcn 仓库

```shell
cat >/compat/linux/etc/pacman.conf <<EOF
[options]
Architecture = auto
ParallelDownloads = 5

[core]
Server = https://mirrors.cernet.edu.cn/archlinux/\$repo/os/\$arch
SigLevel = Required DatabaseOptional

[extra]
Server = https://mirrors.cernet.edu.cn/archlinux/\$repo/os/\$arch
SigLevel = Required DatabaseOptional

[archlinuxcn]
Server = https://mirrors.cernet.edu.cn/archlinuxcn/\$arch
SigLevel = Required DatabaseOptional
EOF
```

## 服务器更新 Arch Linux 运行时环境，并安装 code-server

```shell
cp /etc/resolv.conf /compat/linux/etc
chroot /compat/linux pacman-key --init
chroot /compat/linux pacman-key --populate
chroot /compat/linux pacman -Syu --noconfirm
chroot /compat/linux pacman -S --noconfirm archlinuxcn-keyring
chroot /compat/linux pacman -S --noconfirm code-server
```

## 服务器删除 Arch Linux 运行时环境中的无用目录

```shell
rm -Rf /compat/linux/home
rm -Rf /compat/linux/root
rm -Rf /compat/linux/usr/local
```

## 服务器安装相关开发工具并切换 shell 至 bash

```shell
pkg-static upgrade -y git bash vim tmux htop llvm bear
chsh -s /usr/local/bin/bash
```

### 安装 code-server 关 bash 什么事？

- 安装 bash 的一个原因在于我们需要确保能够成功诱导 code-server 启动安装在 FreeBSD 上的 shell
- 安装 bash 的另一个原因在于 Integrated Terminal 的 Shell Integration 功能只支持 bash, zsh 和 pwsh

### 为什么要诱导 code-server 去启动安装在 FreeBSD 上的 shell ？

- 你不想当你打开 shell 的时候因为 `/compat/linux/etc/passwd` 里面没有你的 UID 而报错吧
- 你也不想你以为你编译了个 FreeBSD 二进制，实际上你编译了个 Linux 二进制吧

### 好吧，那你凭什么断言只要安装了 bash 就可以诱导成功？

- 诱导成功的充要条件在于 `/compat/linux` 下面找不到对应的目录结构，而这个目录结构在 FreeBSD 上是存在的
- FreeBSD 上的 bash 是装在 `/usr/local` 下面的，而这个目录结构在上一步被我们从 `/compat/linux` 里面删了
- 同理，删除 `/compat/linux` 下面的 `/home` 和 `/root` 就可以诱导到 FreeBSD 上的家目录

## 服务器安装 clangd 插件并添加以下 code-server 设置

```shell
code-server --install-extension llvm-vs-code-extensions.vscode-clangd
mkdir -p /root/.local/share/code-server/Machine
cat >/root/.local/share/code-server/Machine/settings.json <<EOF
{
  "clangd.path": "/usr/local/bin/clangd",
  "terminal.integrated.profiles.linux": {
    "bash": { "path": "/usr/local/bin/bash" }
  }
}
EOF
```

## 服务器通过 daemon 命令启动 code-server

```shell
daemon -p /root/.code-server.pid -f /compat/linux/lib/code-server/bin/code-server --auth=none
```

## 客户端通过 SSH 建立隧道并通过浏览器连接到 code-server 服务器

```shell
ssh -L 8080:127.0.0.1:8080 -N root@server
```

在浏览器中访问 [http://127.0.0.1:8080](http://127.0.0.1:8080)

## （示例）浏览器中用 code-server 打开 FreeBSD 的源码树

```shell
rm -Rf /compat/linux/usr/src
code-server /usr/src
```

### 你刚才删了个什么？

- 。。。

## （示例）浏览器中编译最小化内核并生成 `compile_commands.json` 文件

```shell
bear --append -- make KERNCONF=MINIMAL buildkernel
```

等待编译完成并生成 `compile_commands.json` 文件，然后你就可以开始阅读内核关键部分的源码了。

## 自动化安装脚本

为了便于读者快速获得开发环境，我们将安装 code-server 的步骤整理成一个脚本：

```shell
#!/bin/sh

set -e

ARCHLINUX_MIRROR="https://mirrors.cernet.edu.cn/archlinux"
ARCHLINUXCN_MIRROR="https://mirrors.cernet.edu.cn/archlinuxcn"
FREEBSD_PKG_MIRROR="https://mirrors.cernet.edu.cn/FreeBSD-pkg"

umount -Af

rm -Rf /compat/linux
rm -Rf /root/archlinux-bootstrap-x86_64.tar.gz
rm -Rf /root/root.x86_64

service linux enable
service linux start
fetch -o /root "${ARCHLINUX_MIRROR}/iso/latest/archlinux-bootstrap-x86_64.tar.gz"
tar -xpf archlinux-bootstrap-x86_64.tar.gz || true
cp -Rf /root/root.x86_64/* /compat/linux

rm -Rf /root/archlinux-bootstrap-x86_64.tar.gz
rm -Rf /root/root.x86_64

mkdir -p /usr/local/etc/pkg/repos
cat >/usr/local/etc/pkg/repos/FreeBSD.conf <<EOF
FreeBSD: { url: "${FREEBSD_PKG_MIRROR}/\${ABI}/latest" }
EOF

cat >/compat/linux/etc/pacman.conf <<EOF
[options]
Architecture = auto
ParallelDownloads = 5

[core]
Server = ${ARCHLINUX_MIRROR}/\$repo/os/\$arch
SigLevel = Required DatabaseOptional

[extra]
Server = ${ARCHLINUX_MIRROR}/\$repo/os/\$arch
SigLevel = Required DatabaseOptional

[archlinuxcn]
Server = ${ARCHLINUXCN_MIRROR}/\$arch
SigLevel = Required DatabaseOptional
EOF

cp /etc/resolv.conf /compat/linux/etc
chroot /compat/linux pacman-key --init
chroot /compat/linux pacman-key --populate
chroot /compat/linux pacman -Syu --noconfirm
chroot /compat/linux pacman -S --noconfirm archlinuxcn-keyring
chroot /compat/linux pacman -S --noconfirm code-server

rm -Rf /compat/linux/home
rm -Rf /compat/linux/root
rm -Rf /compat/linux/usr/local
rm -Rf /compat/linux/usr/src

pkg-static upgrade -y git bash vim tmux htop llvm bear
chsh -s /usr/local/bin/bash

code-server --install-extension llvm-vs-code-extensions.vscode-clangd
mkdir -p /root/.local/share/code-server/Machine
cat >/root/.local/share/code-server/Machine/settings.json <<EOF
{
  "clangd.path": "/usr/local/bin/clangd",
  "terminal.integrated.profiles.linux": {
    "bash": { "path": "/usr/local/bin/bash" }
  }
}
EOF
```

欢迎测试与反馈。
