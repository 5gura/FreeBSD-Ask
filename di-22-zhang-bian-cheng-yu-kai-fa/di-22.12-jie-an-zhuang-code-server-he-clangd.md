# 第 22.12 节 安装 code-server 和 clangd

> **警告**
>
> 本教程仍然需要进一步测试，请慎重参考。

需要补充说明的教程目标描述：

- 不用安装桌面环境即可获得运行在原生 FreeBSD 环境上的集成开发环境
- 利用熟悉的 vscode 界面和强大的 clangd 插件支援 FreeBSD 内核、驱动的开发

需要补充的教程内容：

- 如何在服务器上通过 HTTPS 来提供 code-server 服务
- 解答你在 Linux 兼容层里面却还是可以访问 FreeBSD 环境的原因
- 探讨 Linux 兼容层与 Linux Jail 究竟有何区别
- 介绍 Linux 兼容层的有关机制

## 服务器启用 Linux 兼容层并部署 archlinux-bootstrap 镜像

```
# service linux enable
# service linux start
# fetch https://mirrors.cernet.edu.cn/archlinux/iso/latest/archlinux-bootstrap-x86_64.tar.gz
# tar -xpf ./archlinux-bootstrap-x86_64.tar.gz
# cp -Rf ./root.x86_64/* /compat/linux
# rm -Rf ./root.x86_64 ./archlinux-bootstrap-x86_64.tar.gz
```

## 服务器配置 pacman 源并添加 archlinuxcn 仓库

```
# cat > /compat/linux/etc/pacman.conf << EOF
[options]
Architecture = auto
ParallelDownloads = 5

[core]
Server = https://mirrors.cernet.edu.cn/archlinux/\$repo/os/\$arch
SigLevel = Required DatabaseOptional

[extra]
Server = https://mirrors.cernet.edu.cn/archlinux/\$repo/os/\$arch
SigLevel = Required DatabaseOptional

[archlinuxcn]
Server = https://mirrors.cernet.edu.cn/archlinuxcn/\$arch
SigLevel = Required DatabaseOptional
EOF
```

## 服务器更新 Arch Linux 运行时环境并安装 code-server

```
# cp /etc/resolv.conf /compat/linux/etc
# chroot /compat/linux pacman-key --init
# chroot /compat/linux pacman-key --populate
# chroot /compat/linux pacman -Syu --noconfirm
# chroot /compat/linux pacman -S --noconfirm archlinuxcn-keyring
# chroot /compat/linux pacman -S --noconfirm code-server
```

## 服务器安装相关工具并切换 shell 至 bash

```
# pkg install -y git bash llvm bear
# chsh -s /usr/local/bin/bash user
```

## 服务器通过 daemon 命令启动 code-server

```
$ daemon -p ~/.code-server.pid -f /compat/linux/lib/code-server/bin/code-server --auth=none
```

## 客户端通过 SSH 建立隧道并通过浏览器连接到 code-server 服务器

```
$ ssh -L 8080:127.0.0.1:8080 -N user@server
```

在浏览器中访问 [http://127.0.0.1:8080](http://127.0.0.1:8080)

## 服务器安装 clangd 插件并添加以下 code-server 设置

```
$ code-server --install-extension llvm-vs-code-extensions.vscode-clangd
$ code-server ~/.local/share/code-server/Machine/settings.json
{
  "clangd.path": "/usr/local/bin/clangd",
  "terminal.integrated.profiles.linux": {
    "bash": { "path": "/usr/local/bin/bash" }
  }
}
```

## 服务器上用 code-server 打开 FreeBSD 的源码树

```
$ rm -Rf /compat/linux/usr/src
$ code-server /usr/src
```

## （示例）编译最小化内核并生成 compile_commands.json 文件

```
# bear --append -- make KERNCONF=MINIMAL buildkernel
```

等待编译完成并生成 `compile_commands.json` 文件，然后你就可以开始阅读内核的关键源码了。

## 注意事项

1. 虽然为了运行 code-server 我们用到了 Linux 兼容层，但是 bash, clangd 还有任何其他工具将全部由 FreeBSD 提供
2. 这是由于我们诱导了 clangd 插件去启动 FreeBSD 上的 clangd, 与此同时我们还诱导了 Integrated Terminal 去启动 FreeBSD 上的 bash
3. 安装 bash 的另一个原因在于 Integrated Terminal 的 Shell Integration 功能只支持 bash, zsh 和 pwsh
4. 删除 `/compat/linux/usr/src` 目录的原因在于我们需要诱导 code-server 去打开 FreeBSD 上的 `/usr/src`

## 自动化安装脚本

为了便于你快速获得开发环境，我们将安装 code-server 的步骤整理成一个脚本：

```
#!/bin/sh
# install-code-server.sh
#
# usage: chmod 0755 ./install-code-server.sh; sudo ./install-code-server.sh
#

set -e

ARCHLINUX_MIRROR="https://mirrors.cernet.edu.cn/archlinux"
ARCHLINUXCN_MIRROR="https://mirrors.cernet.edu.cn/archlinuxcn"
FREEBSD_PKG_MIRROR="https://mirrors.cernet.edu.cn/FreeBSD-pkg"

umount -Af

rm -Rf /compat/linux
rm -Rf ./root.x86_64 ./archlinux-bootstrap-x86_64.tar.gz

service linux enable
service linux start
fetch "${ARCHLINUX_MIRROR}/iso/latest/archlinux-bootstrap-x86_64.tar.gz"
tar -xpf ./archlinux-bootstrap-x86_64.tar.gz || true

cp -Rf ./root.x86_64/* /compat/linux
rm -Rf ./root.x86_64 ./archlinux-bootstrap-x86_64.tar.gz

cat >/compat/linux/etc/pacman.conf <<EOF
[options]
Architecture = auto
ParallelDownloads = 5

[core]
Server = ${ARCHLINUX_MIRROR}/\$repo/os/\$arch
SigLevel = Required DatabaseOptional

[extra]
Server = ${ARCHLINUX_MIRROR}/\$repo/os/\$arch
SigLevel = Required DatabaseOptional

[archlinuxcn]
Server = ${ARCHLINUXCN_MIRROR}/\$arch
SigLevel = Required DatabaseOptional
EOF

cp /etc/resolv.conf /compat/linux/etc

chroot /compat/linux pacman-key --init
chroot /compat/linux pacman-key --populate
chroot /compat/linux pacman -Syu --noconfirm
chroot /compat/linux pacman -S --noconfirm archlinuxcn-keyring
chroot /compat/linux pacman -S --noconfirm code-server

cat >/usr/local/etc/pkg/repos/FreeBSD.conf <<EOF
FreeBSD: { url: "${FREEBSD_PKG_MIRROR}/\${ABI}/latest" }
EOF

pkg upgrade -y git bash llvm bear
```

欢迎用户测试与反馈。
